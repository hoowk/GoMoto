<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoMoto - Rastreamento</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css">
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
</head>
<body>
    <div id="map"></div>
    <div id="status">Iniciando rastreamento...</div>
    <div class="toggle-container">
        <label class="switch">
            <input type="checkbox" id="toggleLocation" onchange="toggleTracking()">
            <span class="slider"></span>
        </label>
        <span id="toggleText">Localização DESLIGADA</span>
    </div>

    <script>
        if (!localStorage.getItem('motoboy')) {
            window.location.href = 'login.html';
        }

        const map = new maplibregl.Map({
            container: 'map',
            style: 'https://api.maptiler.com/maps/streets-v2/style.json?key=kEB2a1outAjGbGUoNn6x',
            center: [-48.5487, -27.5928],
            zoom: 14
        });

        const el = document.createElement('div');
        el.className = 'moto-marker';
        const marker = new maplibregl.Marker({ element: el, anchor: 'bottom' })
            .setLngLat([-48.5487, -27.5928]).addTo(map);

        let watchID;
        function toggleTracking() {
            const toggle = document.getElementById('toggleLocation');
            const statusText = document.getElementById('toggleText');
            if (toggle.checked) {
                statusText.innerText = "Localização LIGADA";
                watchID = navigator.geolocation.watchPosition(updatePosition, showError, { enableHighAccuracy: true });
            } else {
                statusText.innerText = "Localização DESLIGADA";
                navigator.geolocation.clearWatch(watchID);
            }
        }

        function updatePosition(pos) {
            const lngLat = [pos.coords.longitude, pos.coords.latitude];
            marker.setLngLat(lngLat);
            map.flyTo({ center: lngLat, zoom: 16 });
            document.getElementById('status').innerHTML = `
                <strong>MOTORISTA</strong><br>
                ${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}<br>
                Precisão: ${pos.coords.accuracy.toFixed(0)}m
            `;
        }

        function showError(err) {
            document.getElementById('status').innerHTML = `<strong style="color:red">ERRO:</strong> ${err.message}`;
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js');
        }
    </script>
</body>
</html>
