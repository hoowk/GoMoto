<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoMoto - Rastreamento Ativo</title>
    <!-- MapLibre -->
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet">
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #status {
            position: absolute; top: 10px; left: 10px;
            background: rgba(255,255,255,0.9);
            padding: 8px; border-radius: 4px;
            z-index: 1000; font-family: Arial;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="status">Iniciando rastreamento...</div>

    <script>
        // 1. INICIALIZAÇÃO DO MAPA
        const map = new maplibregl.Map({
            container: 'map',
            style: 'https://api.maptiler.com/maps/streets-v2/style.json?key=kEB2a1outAjGbGUoNn6x', // CHAVE CORRETA
            center: [-48.5487, -27.5928], // Coordenadas de Florianópolis/SC
            zoom: 14
        });

        // 2. CONTROLES
        map.addControl(new maplibregl.NavigationControl());
        const geolocate = new maplibregl.GeolocateControl({
            positionOptions: { enableHighAccuracy: true },
            trackUserLocation: true,
            showAccuracyCircle: true
        });
        map.addControl(geolocate);

        // 3. MARCADOR PERSONALIZADO (MOTO)
        const marker = new maplibregl.Marker({
            color: "#FF0000",
            scale: 1.2
        }).setLngLat([-48.5487, -27.5928]).addTo(map);

        // 4. RASTREAMENTO EM TEMPO REAL
        geolocate.on('geolocate', (e) => {
            const lon = e.coords.longitude;
            const lat = e.coords.latitude;
            
            // Atualiza marcador
            marker.setLngLat([lon, lat]);
            
            // Centraliza no usuário
            map.flyTo({ center: [lon, lat], zoom: 16 });
            
            // Atualiza status
            document.getElementById('status').innerHTML = `
                <b>POSIÇÃO ATUAL</b><br>
                ${lat.toFixed(5)}, ${lon.toFixed(5)}<br>
                Precisão: ${e.coords.accuracy.toFixed(0)}m
            `;
        });

        // 5. TRATAMENTO DE ERROS
        geolocate.on('error', (e) => {
            document.getElementById('status').innerHTML = 
                `<b style="color:red">ERRO:</b> ${e.message}`;
        });

        // 6. FORÇAR INÍCIO DO RASTREAMENTO
        map.on('load', () => {
            geolocate.trigger(); // Inicia imediatamente
        });
    </script>
</body>
</html>
