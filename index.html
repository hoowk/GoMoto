<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoMoto - Rastreamento</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    
    <!-- MapLibre -->
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css">
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; font-family: Arial; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #status {
            position: absolute; top: 10px; left: 10px;
            background: rgba(255,255,255,0.9);
            padding: 8px 12px; border-radius: 4px;
            z-index: 1000; font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .moto-marker {
            width: 40px; height: 40px;
            background-image: url('icons/moto.png');
            background-size: contain;
            filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.3));
        }
        #recenter {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #007BFF; color: white; border: none; padding: 10px 15px;
            border-radius: 5px; cursor: pointer; font-size: 14px;
            box-shadow: 0px 2px 5px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="status">Iniciando rastreamento...</div>
    <button id="recenter">Voltar ao Motoboy</button>

    <script>
        let userMovedMap = false;
        const map = new maplibregl.Map({
            container: 'map',
            style: 'https://api.maptiler.com/maps/streets-v2/style.json?key=kEB2a1outAjGbGUoNn6x',
            center: [-48.5487, -27.5928], // Florianópolis
            zoom: 14
        });

        // Marcador (moto.png)
        const el = document.createElement('div');
        el.className = 'moto-marker';
        const marker = new maplibregl.Marker({ element: el, anchor: 'bottom' }).setLngLat([-48.5487, -27.5928]).addTo(map);
        
        // Detecta se o usuário moveu o mapa
        map.on('movestart', () => { userMovedMap = true; });

        // GPS
        let lastPosition = null;
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(
                (pos) => {
                    const lngLat = [pos.coords.longitude, pos.coords.latitude];
                    marker.setLngLat(lngLat);
                    lastPosition = lngLat;
                    
                    if (!userMovedMap) {
                        map.flyTo({ center: lngLat, zoom: 16 });
                    }
                    
                    document.getElementById('status').innerHTML = `
                        <strong>MOTORISTA</strong><br>
                        ${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}<br>
                        Precisão: ${pos.coords.accuracy.toFixed(0)}m
                    `;
                },
                (err) => {
                    document.getElementById('status').innerHTML = `<strong style="color:red">ERRO:</strong> ${err.message}`;
                },
                { enableHighAccuracy: true }
            );
        }

        // Botão para recentralizar
        document.getElementById('recenter').addEventListener('click', () => {
            if (lastPosition) {
                userMovedMap = false;
                map.flyTo({ center: lastPosition, zoom: 16 });
            }
        });

        // PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js');
        }
    </script>
</body>
</html>
